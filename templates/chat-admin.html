{% extends "admin_templates/../base-admin.html" %}
{% load static %}
{% block styles %}
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;900&family=Roboto:wght@400;500&family=Megrim&display=swap"
      rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="{% static 'css/platform-student.css' %}">
  <link rel="stylesheet" href="{% static 'css/platform-student-responsive.css' %}">
{% endblock %}

{% block title %}Чат з Учнем - {{ block.super }}{% endblock %}
{% block header_title %}Чат з Учнем '{{ interlocutor.get_full_name }}'{% endblock %}

{% block content %}
  <div class="chat-container">
    <div class="chat-messages">
      {% if page_obj.has_previous %}
        <div class="load-more-container">
          <button id="load-more-btn" class="btn btn-secondary">Завантажити попередні</button>
        </div>
      {% endif %}
      {% if messages %}
        {% for msg in messages %}

          {% if not msg.from_admin %}
            <div class="message received">
              <img src="{{ interlocutor.avatar.url }}" alt="User Avatar" class="message-avatar">
              <div class="message-bubble">
                <p>{{ msg.text }}</p>
                {% if msg.image %}
                  <div class="message-attachment">
                    <img src="{{ msg.image.url }}" alt="Homework Image">
                  </div>
                {% endif %}
                <div class="message-time">{{ msg.date }}</div>
              </div>
            </div>
          {% elif msg.from_admin %}
            <div class="message sent">
              <img src="{{ user.avatar.url }}" alt="Mentor Avatar" class="message-avatar">
              <div class="message-bubble">
                <p>{{ msg.text }}</p>
                {% if msg.image %}
                  <div class="message-attachment">
                    <img src="{{ msg.image.url }}" alt="Homework Image">
                  </div>
                {% endif %}
                <div class="message-time">{{ msg.date }}</div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      {% endif %}
    </div>

    <div class="chat-input-area">
      <div id="upload-preview-container"></div>
      <form class="chat-form" method="post" enctype="multipart/form-data">
        {% csrf_token %}
        <label for="file-upload-input" class="btn-icon" aria-label="Прикріпити фото">
          <i class="fas fa-paperclip"></i>
        </label>
        <input type="file" id="file-upload-input" name="image" accept="image/*" style="display: none;">
        <textarea class="autoresize-textarea" name="text" placeholder="Напишіть повідомлення..." rows="1"></textarea>
        <button type="submit" class="btn-icon send-btn" aria-label="Надіслати">
          <i class="fas fa-paper-plane"></i>
        </button>
      </form>
    </div>
  </div>

  <div id="imageModal" class="image-modal">
    <span class="modal-close-btn">&times;</span>
    <img class="modal-content" id="modalImage">
  </div>
{% endblock %}
{% block scripts %}
  {{ block.super }}
  <script>
      document.addEventListener('DOMContentLoaded', function () {
          const chatMessages = document.querySelector('.chat-messages');
          if (chatMessages) {
              chatMessages.scrollTop = chatMessages.scrollHeight;
          }

          const loadMoreBtn = document.getElementById('load-more-btn');
          if (!loadMoreBtn) return;

          // ВИПРАВЛЕНО: Починаємо з поточної сторінки
          let currentPageNumber = parseInt("{{ page_obj.number }}");

          loadMoreBtn.addEventListener('click', async () => {
              // ВИПРАВЛЕНО: Перевіряємо, чи є попередня сторінка
              if (currentPageNumber <= 1) {
                  loadMoreBtn.style.display = 'none';
                  return;
              }

              // ВИПРАВЛЕНО: Запитуємо попередню сторінку
              const previousPageNumber = currentPageNumber - 1;
              const loadUrl = "{% url 'load_more_messages' chat_pk %}";

              loadMoreBtn.textContent = 'Завантаження...';
              loadMoreBtn.disabled = true;

              const response = await fetch(`${loadUrl}?page=${previousPageNumber}`);
              const newMessagesHtml = await response.text();

              // Зберігаємо поточну висоту скролу, щоб чат не "стрибав"
              const oldScrollHeight = chatMessages.scrollHeight;

              // Вставляємо нові повідомлення після кнопки
              loadMoreBtn.parentElement.insertAdjacentHTML('afterend', newMessagesHtml);

              // Відновлюємо позицію скролу
              chatMessages.scrollTop = chatMessages.scrollHeight - oldScrollHeight;

              loadMoreBtn.textContent = 'Завантажити попередні';
              loadMoreBtn.disabled = false;

              // Оновлюємо номер поточної сторінки
              currentPageNumber = previousPageNumber;

              // Ховаємо кнопку, якщо дійшли до першої сторінки
              if (currentPageNumber <= 1) {
                  loadMoreBtn.style.display = 'none';
              }
          });
      });
  </script>
{% endblock %}